{% extends "base.html" %}
{% block title %}{{ report.title }} · FSI Expenses{% endblock %}
{% block content %}
  <section>
    <h2>Report details</h2>
    {% if form_errors %}
      <ul class="error-list">
        {% for error in form_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    <form method="post" action="{{ url_for('reports.update_report', report_id=report.id) }}" class="form-grid">
      <div class="form-grid two-column">
        <div>
          <label for="title">Report title</label>
          <input type="text" name="title" id="title" value="{{ report.title }}" required />
        </div>
        <div>
          <label for="traveler_name">Traveler name</label>
          <input type="text" name="traveler_name" id="traveler_name" value="{{ report.traveler_name }}" required />
        </div>
        <div>
          <label for="department">Department</label>
          <input type="text" name="department" id="department" value="{{ report.department }}" required />
        </div>
        <div>
          <label for="purpose">Purpose</label>
          <input type="text" name="purpose" id="purpose" value="{{ report.purpose }}" />
        </div>
        <div>
          <label for="trip_start">Trip start</label>
          <input type="date" name="trip_start" id="trip_start" value="{{ report.trip_start }}" required />
        </div>
        <div>
          <label for="trip_end">Trip end</label>
          <input type="date" name="trip_end" id="trip_end" value="{{ report.trip_end }}" required />
        </div>
      </div>
      <div>
        <label for="notes">Notes</label>
        <textarea name="notes" id="notes">{{ report.notes }}</textarea>
      </div>
      <label class="checkbox">
        <input type="checkbox" name="policy_acknowledged" {% if report.policy_acknowledged %}checked{% endif %} /> I confirm that all expenses comply with company policy.
      </label>
      <button type="submit">Save changes</button>
      <a class="button-link" href="{{ url_for('reports.preview_report', report_id=report.id) }}">Preview</a>
    </form>
  </section>
  <section>
    <h2>Expenses</h2>
    {% if report.expenses %}
      <table class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Description</th>
            <th>Merchant</th>
            <th>Amount</th>
            <th>Type</th>
            <th>Receipt</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for item in report.expenses %}
            <tr>
              <td>{{ item.expense_date }}</td>
              <td>{{ item.category }}</td>
              <td>{{ item.description }}</td>
              <td>{{ item.merchant }}</td>
              <td>${{ '%.2f'|format(item.amount) }} {{ item.currency }}</td>
              <td>{% if item.reimbursable %}Reimbursable{% else %}Non-reimbursable{% endif %}</td>
              <td>
                {% if item.receipt_filename %}
                  <a href="{{ url_for('reports.get_receipt', filename=item.receipt_filename) }}">Download</a>
                {% else %}
                  —
                {% endif %}
              </td>
              <td>
                <form method="post" action="{{ url_for('reports.delete_expense_item', report_id=report.id, item_id=item.id) }}">
                  <button type="submit" class="secondary">Delete</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No expenses recorded yet.</p>
    {% endif %}
  </section>
  <section>
    <h2>Add expense</h2>
    {% if item_errors %}
      <ul class="error-list">
        {% for error in item_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    <form method="post" enctype="multipart/form-data" action="{{ url_for('reports.add_expense_item', report_id=report.id) }}" class="form-grid">
      <div class="form-grid two-column">
        <div>
          <label for="expense_date">Expense date</label>
          <input type="date" name="expense_date" id="expense_date" required />
        </div>
        <div>
          <label for="category">Category</label>
          <select name="category" id="category" required>
            <option value="">Select category…</option>
            {% for category in expense_categories %}
              <option value="{{ category.code }}">{{ category.label }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="merchant">Merchant</label>
          <input type="text" name="merchant" id="merchant" required />
        </div>
        <div>
          <label for="amount">Amount (USD)</label>
          <input type="number" step="0.01" name="amount" id="amount" required />
        </div>
      </div>
      <div>
        <label for="description">Description</label>
        <textarea name="description" id="description" required></textarea>
      </div>
      <div class="form-grid two-column">
        <div>
          <label for="currency">Currency</label>
          <input type="text" name="currency" id="currency" value="USD" />
        </div>
        <label class="checkbox">
          <input type="checkbox" name="reimbursable" checked /> Reimbursable expense
        </label>
      </div>
      <div>
        <label for="receipt">Receipt upload</label>
        <input type="file" name="receipt" id="receipt" accept="image/*,application/pdf" />
      </div>
      <button type="submit">Add expense</button>
    </form>
  </section>
{% endblock %}
